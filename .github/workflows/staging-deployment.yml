# Staging Deployment Workflow
#
# This workflow automatically triggers when code is pushed to the 'main' branch.
# It creates beta releases for testing and deploys to the staging environment.
# This serves as the testing ground before production releases.
#
# Role in release workflow:
# - Triggered by pushes to 'main' branch (from feature branch merges)
# - Creates semantic release with beta version (e.g., v1.2.0-beta.1)
# - Deploys to staging environment for testing (done on the Cloudflare Pages side)
# - Allows validation before promoting to production

name: Staging Deployment

on:
  push:
    branches: [main]
    paths-ignore:
      - 'docs/**'
      - '**.md'
      - '.vscode/**'
      - '.idea/**'

concurrency:
  group: staging-deployment
  cancel-in-progress: true

jobs:
  ci:
    name: CI
    uses: makerxstudio/shared-config/.github/workflows/node-ci.yml@main
    with:
      working-directory: .
      node-version: 20.x
      audit-script: npm run audit
      compile-script: npm run check-types
      test-script: npm run test
      pre-test-script: |
        pipx install algokit
        algokit localnet start
        npx --yes wait-on tcp:4001 -t 30000

  version-and-release:
    name: Create Beta Release
    needs: ci
    runs-on: ubuntu-22.04
    outputs:
      version: ${{ steps.semantic-release.outputs.new-release-version }}
      released: ${{ steps.semantic-release.outputs.new-release-published }}
    steps:
      - name: Generate bot token
        uses: actions/create-github-app-token@v1
        id: app_token
        with:
          app-id: ${{ secrets.BOT_ID }}
          private-key: ${{ secrets.BOT_SK }}

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ steps.app_token.outputs.token }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Set Git user as GitHub actions
        run: git config --global user.email "179917785+engineering-ci[bot]@users.noreply.github.com" && git config --global user.name "engineering-ci[bot]"

      - name: Run semantic-release for staging
        id: semantic-release
        run: npx semantic-release
        env:
          GITHUB_TOKEN: ${{ steps.app_token.outputs.token }}
